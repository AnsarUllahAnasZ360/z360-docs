---
title: Build And Deployment
---

# Z360 VoIP Build and Deployment Guide

## 1. DEVELOPMENT ENVIRONMENT SETUP

### 1.1 Docker-Based Architecture

Z360 runs entirely in Docker for development. No local PHP, Node.js, or database installation required.

**Docker Services** (defined in `docker-compose.yml`):

| Service | Image | Ports | Purpose |
|---------|-------|-------|---------|
| `app` | `z360:dev` (built from `docker/Dockerfile`, target: `development`) | `7360:80`, `5173:5173`, `5174:5174` | Laravel app + Vite dev servers |
| `queue` | `z360:dev` | none | Queue worker (`php artisan queue:listen`) |
| `reverb` | `z360:dev` | `7361:8080` | WebSocket server (`php artisan reverb:start`) |
| `pgsql` | `postgres:17` | `5432:5432` | PostgreSQL database |
| `valkey` | `valkey/valkey:alpine` | `6379:6379` | Redis-compatible cache/queue/session store |
| `minio` | `minio/minio:latest` | `9000:9000`, `8900:8900` | S3-compatible object storage |
| `pgadmin` | `dpage/pgadmin4` (profile: pgadmin) | `7362:80` | Database GUI (optional) |
| `ngrok` | `ngrok/ngrok` (profile: tunnel) | none | Tunnel for webhook testing (optional) |

**Reference**: `docker-compose.yml`

### 1.2 First-Time Setup

```bash
make setup    # Complete setup: build + install deps + generate .env + migrate + seed
```

This runs sequentially:
1. `make install` - Builds Docker image, installs Composer + PNPM dependencies, generates `.env` via `php artisan make:env`
2. `make seed-files` - Copies seed assets (avatars, etc.) from `resources/seeds/` to `storage/app/`
3. `make migrate` - Runs database migrations
4. `make seed` - Seeds database

**Reference**: `Makefile:295-365`

### 1.3 Daily Development Workflow

```bash
make up       # Start all services (docker compose up -d)
make down     # Stop all services
make shell    # Access app container bash as appuser
make logs     # View logs (default: app service; usage: make logs service=queue)
```

**Reference**: `Makefile:166-195`

### 1.4 Development Server

The `app` container runs `composer run dev` on startup, which launches 4 processes concurrently:

1. `php artisan serve --host=0.0.0.0 --port=80` - Laravel HTTP server
2. `php artisan pail --timeout=0` - Real-time log viewer
3. `pnpm run dev` - Vite dev server (port 5173) for main app
4. `pnpm run dev:widget` - Vite dev server (port 5174) for embedded widget

**Reference**: `composer.json:62-65`, `docker-compose.yml:13`

### 1.5 Dockerfile Details

The `docker/Dockerfile` is a multi-stage build:

**Base stage**: Ubuntu 24.04 with:
- PHP 8.4 (cli) with extensions: pgsql, gd, curl, mbstring, imap, xml, zip, bcmath, soap, intl, readline, ldap, msgpack, igbinary, redis, swoole, pcov, imagick
- Node.js 22 + PNPM (global install)
- Composer
- PostgreSQL client 17
- Python 3 with markitdown package

**Development stage**: Adds Xdebug, creates `appuser` (UID/GID 1337), uses development entrypoint that remaps user IDs to match host.

**Production stage**: Adds Nginx + PHP-FPM 8.4, installs dependencies, builds frontend (`pnpm run build:all`), strips dev deps, runs via Supervisord (nginx + php-fpm).

**Reference**: `docker/Dockerfile`

### 1.6 Environment Configuration

The `.env` system has three layers:
1. `.env.base` - Tracked in git, contains defaults for all variables
2. `.env.base.override` - Gitignored, developer-specific overrides (real Telnyx keys, Firebase credentials, etc.)
3. `.env` - Generated by `php artisan make:env`, combines base + override

To regenerate after changes: `make env`

**Reference**: `.env.base`, `.gitignore:15` (`.env.base.override` is gitignored)

### 1.7 Webhook Testing with Cloudflare Tunnel

Z360 uses **Cloudflare Tunnel** (not ngrok) as the primary method to expose the local dev server to Telnyx and other webhook providers.

**Setup**:
1. Obtain `tunnel-credentials.json` from team lead
2. Place in `.cloudflared/tunnel-credentials.json`
3. Run `make tunnel-bg` (background) or `make tunnel` (foreground)

**Tunnel routes** (defined in `.cloudflared/config.yml`):
- `dev.z360.cloud` -> `http://localhost:7360` (main app)
- `dev-storage.z360.cloud` -> `http://localhost:9000` (MinIO storage)

**Tunnel management**:
```bash
make tunnel-bg       # Start in background
make tunnel-stop     # Stop tunnel
make tunnel-status   # Check status + test connectivity
```

**Reference**: `.cloudflared/config.yml`, `Makefile:649-714`

**Alternative**: Docker-based ngrok is also available as a profile:
```bash
make profile-up profile=ngrok
```
Requires `NGROK_AUTHTOKEN` and `NGROK_HOSTNAME` in `.env`.

**Reference**: `docker-compose.yml:166-181`, `.env.base:189-190`

### 1.8 Push Notification Testing in Development

Push notifications require:
1. **Firebase project credentials** - Set `FIREBASE_CREDENTIALS` in `.env.base.override` pointing to the Firebase Admin SDK JSON file (stored in `storage/`)
2. **Telnyx Notification Profile** - Set `TELNYX_NOTIFICATIONS_PROFILE_ID` for the Telnyx push notification channel
3. **Device tokens** - The mobile app registers device tokens when users sign in
4. **Cloudflare tunnel** - Must be running so Telnyx webhooks can reach the local server

**iOS push testing**: PushKit/VoIP push notifications CANNOT be tested on Simulator. A physical device with proper provisioning profile is required. The `aps-environment` entitlement is currently set to `development`.

**Android push testing**: FCM push works on emulators with Google Play services. The `google-services.json` file (gitignored) must be placed in `android/app/`.

**Reference**: `.env.base:183-184`, `.env.base.override:87`, `ios/App/App/App.entitlements`, `android/app/build.gradle:141-148`

### 1.9 Dependency Management

**PHP (Composer)**:
```bash
make composer cmd="install"          # Install deps
make composer cmd="require package"  # Add package
make composer cmd="update"           # Update deps
```

**Node.js (PNPM)**:
```bash
make pnpm cmd="install"       # Install deps
make pnpm cmd="add package"   # Add package
make pnpm cmd="run dev"       # Start dev server
make pnpm cmd="run build"     # Production build
```

**Reference**: `Makefile:236-245`

---

## 2. WEB CLIENT BUILD

### 2.1 Vite Build Process

The web client uses Vite with two separate configurations:

**Main App** (`vite.config.ts`):
- Entry points: `resources/css/app.css`, `resources/js/app.tsx`
- Plugins: `laravel-vite-plugin`, `@vitejs/plugin-react`, `@tailwindcss/vite`, `vite-plugin-svgr`
- Dev server: port 5173, HMR via `wss://dev.z360.cloud:5173`
- Cache directory: `node_modules/.vite/main`

**Widget** (`vite.widget.config.ts`):
- Entry points: `resources/js/widget/index.html` (iframe), `resources/js/widget/loader.ts` (stable URL loader)
- Output: `public/widget/`
- Dev server: port 5174
- Base path: `./` (relative, for embeddable widget)
- Loader file output is un-hashed (`loader.js`) for stable tenant URLs

**Build commands**:
```bash
pnpm run build           # Main app only
pnpm run build:widget    # Widget only
pnpm run build:all       # Both (used in production Dockerfile)
```

**Reference**: `vite.config.ts`, `vite.widget.config.ts`, `package.json:5-14`

### 2.2 Inertia.js SSR

There is **no SSR configuration** in the current codebase. The `bootstrap/ssr` directory is gitignored but no SSR entry point or server-side rendering setup exists. Z360 runs as a pure client-side SPA via Inertia.js.

**Reference**: `.gitignore:2` (`/bootstrap/ssr`)

### 2.3 Web VoIP Client

The web VoIP client uses:
- `@telnyx/react-client` (^1.0.2) - React wrapper for Telnyx WebRTC
- `@telnyx/webrtc` (^2.22.17) - Core Telnyx WebRTC SDK

These are bundled directly into the Vite build output. No separate build step is needed.

**Reference**: `package.json:81-82`

### 2.4 Asset Deployment

Production builds output to `public/build/` (main app) and `public/widget/` (widget). Both directories are gitignored and built during Docker image creation. The production Dockerfile runs `pnpm run build:all` then removes `node_modules`.

**Reference**: `docker/Dockerfile:107`, `.gitignore:4-5`

---

## 3. ANDROID BUILD PROCESS

### 3.1 Capacitor Sync

Before building, web assets must be synced to the native project:

```bash
npx cap sync android
```

This copies `public/` into `android/app/src/main/assets/public/` and generates `capacitor.config.json` and `capacitor.plugins.json` in `android/app/src/main/assets/`.

**Important**: The `make android-build` command first removes `public/hot` from the Docker container to ensure the app runs in "mobile mode" (not Vite dev mode):
```bash
docker compose exec -T app rm -f public/hot 2>/dev/null || true
```

**Reference**: `Makefile:797-800`, `capacitor.config.ts`

### 3.2 Capacitor Configuration

**File**: `capacitor.config.ts`

| Setting | Value | Notes |
|---------|-------|-------|
| `appId` | `com.z360.app` | Bundle identifier |
| `appName` | `Z360` | Display name |
| `webDir` | `public` | Web assets directory |
| `appendUserAgent` | `Z360Capacitor` | Identifies Capacitor WebView to server |
| `server.url` | `CAPACITOR_SERVER_URL` env var | Points to dev server in development |
| `server.cleartext` | `true` (dev only) | Allows HTTP in development |
| Keyboard resize | `None` | Handled via CSS `env(safe-area-inset-*)` |
| PushNotifications | `['badge', 'sound']` | No 'alert' - foreground handled via LocalNotifications |

**Reference**: `capacitor.config.ts`

### 3.3 How Native VoIP + Capacitor WebView Combine

The Android app is a standard Capacitor project with **additional native Kotlin VoIP modules**:

**Gradle modules** (`android/settings.gradle`):
1. `:app` - Main Capacitor app (WebView + native VoIP code)
2. `:capacitor-android` - Capacitor core (imported via `capacitor.settings.gradle`)
3. `:capacitor-cordova-android-plugins` - Capacitor plugin bridge
4. `:telnyx_common` - Official Telnyx drop-in module (TelnyxViewModel, CallForegroundService, etc.)

The `:app` module contains both:
- Capacitor WebView (loads web app from `assets/public/`)
- Native Kotlin VoIP code in `app/src/main/java/com/z360/app/voip/` and `app/src/main/java/com/z360/app/fcm/`
- Custom Capacitor plugin (`TelnyxVoipPlugin`) bridging JS <-> native VoIP

**Reference**: `android/settings.gradle`, `android/app/build.gradle`

### 3.4 Gradle Build Process

**Debug build**:
```bash
cd android && JAVA_HOME="<path>" ./gradlew assembleDebug
```

**The full `make android-build` workflow**:
1. Remove `public/hot` from Docker container
2. `npx cap sync android` - Sync web assets
3. `./gradlew assembleDebug` - Build APK (with auto-retry on failure: cleans Gradle transform cache)
4. `adb install -r android/app/build/outputs/apk/debug/app-debug.apk` - Install on device
5. `adb shell am start -n com.z360.app/.MainActivity` - Launch app

**Reference**: `Makefile:791-831`

### 3.5 Dependencies

**Direct dependencies** (`android/app/build.gradle:74-137`):

| Category | Dependency | Version |
|----------|-----------|---------|
| **Telnyx SDK** | `com.github.team-telnyx:telnyx-webrtc-android` | 3.2.0 (via JitPack; v3.3.0 has credential auth bug) |
| **Telnyx Common** | `:telnyx_common` local module | Cloned from official Telnyx repo |
| **Firebase BOM** | `com.google.firebase:firebase-bom` | 33.7.0 |
| **Firebase Messaging** | `firebase-messaging-ktx` | BOM-managed |
| **Firebase Analytics** | `firebase-analytics-ktx` | BOM-managed |
| **Firebase Crashlytics** | `firebase-crashlytics-ktx` | BOM-managed |
| **Firebase Performance** | `firebase-perf-ktx` | BOM-managed |
| **Firebase Remote Config** | `firebase-config-ktx` | BOM-managed |
| **Kotlin** | `kotlin-stdlib` | 1.9.24 |
| **Coroutines** | `kotlinx-coroutines-core/android` | 1.7.3 (forced, avoids Telnyx SDK conflicts) |
| **Lifecycle** | `lifecycle-runtime-ktx`, `lifecycle-process` | 2.6.2 |
| **UI** | `constraintlayout`, `material` | 2.1.4, 1.12.0 |
| **Image loading** | `coil` | 2.6.0 |
| **JSON parsing** | `gson` | 2.10.1 |

**Gradle plugins** (`android/build.gradle`):
- `com.android.tools.build:gradle:8.13.2`
- `com.google.gms:google-services:4.4.4`
- `com.google.firebase:firebase-crashlytics-gradle:3.0.3`
- `com.google.firebase:perf-plugin:1.4.2`
- `org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24`

**Reference**: `android/app/build.gradle`, `android/build.gradle`, `android/telnyx_common/build.gradle`

### 3.6 SDK Version Requirements

**File**: `android/variables.gradle`

| Variable | Value |
|----------|-------|
| `minSdkVersion` | 24 (Android 7.0) |
| `compileSdkVersion` | 36 |
| `targetSdkVersion` | 36 |
| `kotlinVersion` | 1.9.24 |
| Java compatibility | 17 (forced in root `build.gradle` for all modules) |

**Reference**: `android/variables.gradle`

### 3.7 Debug vs Release Builds

**Debug**:
- `./gradlew assembleDebug`
- Output: `android/app/build/outputs/apk/debug/app-debug.apk`
- No minification (`minifyEnabled false` even in release)
- No signing configuration needed

**Release**:
- `./gradlew assembleRelease`
- Requires `android/keystore.properties` file with:
  ```properties
  storeFile=path/to/keystore.jks
  storePassword=...
  keyAlias=...
  keyPassword=...
  ```
- No keystore.properties file exists currently (gitignored check: not in `.gitignore` but file doesn't exist)
- Release signing config only activates if `keystoreProperties['storeFile']` is present

**Reference**: `android/app/build.gradle:6-22,36-42`

### 3.8 ProGuard/R8 Configuration

**Minification is DISABLED** for both debug and release builds (`minifyEnabled false`). The `proguard-rules.pro` file exists but contains only default comments with no custom rules.

**Reference**: `android/app/build.gradle:39`, `android/app/proguard-rules.pro`

### 3.9 Resolution Strategy (Kotlin Version Pinning)

Due to conflicts between AGP 9.0 (which pulls Kotlin 2.0+) and the Telnyx SDK (which needs Kotlin 1.9.x), a forced resolution strategy pins:
- `kotlin-stdlib*` to 1.9.24
- `kotlinx-coroutines-*` to 1.7.3

**Reference**: `android/app/build.gradle:58-72`

### 3.10 Firebase Configuration

The `google-services.json` file is **gitignored** (`android/app/google-services.json`). It must be obtained from the Firebase Console and placed manually. The Google Services plugin is applied conditionally - if the file doesn't exist, push notifications won't work but the app will still build.

**Reference**: `android/app/build.gradle:141-148`, `.gitignore:83`

### 3.11 Android Emulator Commands

```bash
make emulator-start    # Start with VoIP settings (audio permissions, GPU host)
make emulator-stop     # Stop emulator
make emulator-status   # Check running status
make emulator-wipe     # Wipe data for fresh start
```

Default AVD name: `Z360_VoIP` (override: `AVD_NAME=MyAVD make emulator-start`)

Emulator starts with: no-snapshot, host audio, host GPU, 2048MB RAM, 4 cores. Auto-configures audio permissions for VoIP testing.

**Reference**: `Makefile:720-785`

---

## 4. iOS BUILD PROCESS

### 4.1 Capacitor Sync

```bash
npx cap sync ios
```

**Important**: After sync, a problematic symlink must be removed:
```bash
rm -f ios/App/App/public/storage
```

This is handled automatically by `make ios-sync` and `make ios-build`.

**Reference**: `Makefile:385-396`

### 4.2 How Native Swift VoIP + Capacitor WebView Combine

The iOS app uses **Xcode project** (not workspace/CocoaPods) with **Swift Package Manager** for dependencies.

**Project**: `ios/App/App.xcodeproj` with scheme `App`

The app contains:
- Capacitor WebView (loads web app from `App/public/`)
- Native Swift VoIP code (in `App/` directory)
- Custom Capacitor plugin bridging JS <-> native VoIP

### 4.3 Dependencies (Swift Package Manager)

| Package | Repository | Min Version |
|---------|-----------|-------------|
| **Telnyx WebRTC iOS** | `https://github.com/team-telnyx/telnyx-webrtc-ios` | 2.4.0 |
| **Firebase iOS SDK** | `https://github.com/firebase/firebase-ios-sdk` | 12.8.0 |

Firebase products used:
- `FirebaseMessaging` - Push notifications (FCM for general, PushKit for VoIP)
- `FirebaseCrashlytics` - Crash reporting
- `FirebaseAnalytics` - Event tracking

**Reference**: `ios/App/App.xcodeproj/project.pbxproj` (repositoryURL entries at lines 754-773)

### 4.4 Xcode Build Process

**Simulator build** (default):
```bash
make ios-build
```

This runs:
1. Remove `public/hot` from Docker container
2. `npx cap sync ios` + remove symlinks
3. `xcodebuild -project ios/App/App.xcodeproj -scheme App -destination 'platform=iOS Simulator,name=iPhone 17 Pro Max' -configuration Debug -derivedDataPath ios/build build`
4. `xcrun simctl install booted ios/build/Build/Products/Debug-iphonesimulator/App.app`
5. `xcrun simctl launch booted com.z360.app`

**Physical device build**:
```bash
make ios-device    # Explicit physical device
make ios-build     # Auto-detects: prefers physical over simulator
```

Auto-detection: `xcrun xctrace list devices` finds connected iPhones. Physical device builds use `-allowProvisioningUpdates`.

**Reference**: `Makefile:497-592`

### 4.5 Required Background Modes

**File**: `ios/App/App/Info.plist` (`UIBackgroundModes`):
- `voip` - VoIP push notifications and background call handling
- `audio` - Background audio during calls
- `remote-notification` - Standard remote notifications
- `fetch` - Background fetch

**Reference**: `ios/App/App/Info.plist:27-33`

### 4.6 Entitlements

**File**: `ios/App/App/App.entitlements`

Currently configured:
- `aps-environment`: `development`

**For production**: This must be changed to `production` or managed through Xcode's automatic signing with a distribution provisioning profile.

**Reference**: `ios/App/App/App.entitlements`

### 4.7 Provisioning Profile Requirements

VoIP apps require specific provisioning:
1. **Apple Developer account** with the VoIP push notification capability enabled
2. **App ID** configured with:
   - Push Notifications capability
   - VoIP Services capability (for PushKit)
   - Background Modes capability
3. **Provisioning profile** that includes the VoIP entitlement
4. **APNs certificates or keys** (.p8 key files are gitignored: `*.p8` in `.gitignore`)

**NEEDS INVESTIGATION**: Specific provisioning profile configuration for the Z360 team Apple Developer account.

### 4.8 Code Signing

- **Development**: Automatic signing via Xcode (`-allowProvisioningUpdates` flag)
- **Distribution**: NEEDS INVESTIGATION - No explicit distribution signing config found. App Store submission would require a distribution certificate and provisioning profile.

### 4.9 App Store Submission Considerations

VoIP apps receive special Apple review scrutiny:
1. **VoIP background mode** must be justified - only apps that provide real-time call functionality qualify
2. **PushKit usage** must exclusively trigger CallKit calls (Apple rejects apps using PushKit for general notifications)
3. **NSMicrophoneUsageDescription**: "Z360 needs access to your microphone to make and receive phone calls." (already set)
4. **NSCameraUsageDescription**: "Z360 needs access to your camera for video calls." (already set, though current focus is voice)

**Reference**: `ios/App/App/Info.plist:76-79`

### 4.10 Firebase Configuration (iOS)

`GoogleService-Info.plist` is present at `ios/App/App/GoogleService-Info.plist` (not gitignored for iOS, unlike Android). It's referenced in the Xcode project and loaded by `AppDelegate.swift`.

**Reference**: `ios/App/App/GoogleService-Info.plist`, `ios/App/App/AppDelegate.swift`

### 4.11 iOS Simulator vs Physical Device

| Feature | Simulator | Physical Device |
|---------|-----------|-----------------|
| UI testing | Yes | Yes |
| PushKit/VoIP push | **No** | Yes |
| CallKit UI | **No** (partially) | Yes |
| Audio testing | Limited | Full |
| Microphone | Host Mac mic | Device mic |
| Apple account | Not required | Required |

**Reference**: `Makefile:443-446`

---

## 5. BACKEND DEPLOYMENT

### 5.1 Production Infrastructure: AWS Copilot on ECS Fargate

Z360 deploys to **AWS ECS Fargate** using **AWS Copilot CLI**. The infrastructure is defined in the `copilot/` directory.

**Services deployed**:

| Service | Type | CPU | Memory | Command |
|---------|------|-----|--------|---------|
| `web` | Load Balanced Web Service | 1024 (staging) / 2048 (beta) | 2048 (staging) / 4096 (beta) | Supervisord (nginx + php-fpm) |
| `queue` | Backend Service | 512 | 1024 | `php artisan queue:work` |
| `reverb` | Load Balanced Web Service | 512 | 1024 | `php artisan reverb:start` |
| `scheduler` | Scheduled Job (every 1 min) | 256 | 512 | `php artisan schedule:run` |

**Reference**: `copilot/web/manifest.yml`, `copilot/queue/manifest.yml`, `copilot/reverb/manifest.yml`, `copilot/scheduler/manifest.yml`

### 5.2 Queue Worker (VoIP-Critical Jobs)

The queue worker runs `php artisan queue:work` in production. VoIP-adjacent queued jobs include:

| Job | File | VoIP Relevance |
|-----|------|---------------|
| `SendSMSJob` | `app/Jobs/Inbox/SendSMSJob.php` | SMS via Telnyx CPaaS |
| `HandleA2PCampaignSuccess` | `app/Jobs/HandleA2PCampaignSuccess.php` | A2P campaign registration |
| `ReportMeterEvent` | `app/Jobs/ReportMeterEvent.php` | Usage metering (calls, SMS) |

**Note**: VoIP call signaling (SIP/WebRTC) is NOT queued - it's real-time via Telnyx SDK. Push notifications are sent synchronously from webhook handlers. The queue handles asynchronous follow-up tasks.

**Reference**: `app/Jobs/`, `docker-compose.yml:32-50`

### 5.3 Webhook Endpoint Accessibility

All webhook endpoints are public (no auth middleware) and must be accessible from the internet:

**Telnyx VoIP-related webhooks** (`routes/webhooks.php`):
| Endpoint | Controller | Purpose |
|----------|-----------|---------|
| `POST /webhooks/cpaas/telnyx/notifications` | `TelnyxNotificationsWebhookController` | Telnyx push notification events |
| `POST /webhooks/cpaas/telnyx/call-control` | `TelnyxInboundWebhookController` | Inbound call control events |
| `POST /webhooks/cpaas/telnyx/call-control/failover` | `TelnyxInboundWebhookController@failover` | Call control failover |
| `POST /webhooks/cpaas/telnyx/credential` | `TelnyxOutboundWebhookController` | Credential-based (outbound) call events |
| `POST /webhooks/cpaas/telnyx/credential/failover` | `TelnyxOutboundWebhookController@failover` | Credential call failover |
| `POST /webhooks/cpaas/telnyx/sms` | `TelnyxSMSWebhookController` | SMS delivery events |
| `POST /webhooks/cpaas/telnyx/a2p` | `TelnyxA2PWebhookController` | A2P campaign events |
| `POST /webhooks/cpaas/telnyx/rcs` | `TelnyxRCSWebhookController` | RCS message events |

**Other webhooks**: Stripe, Gmail, Agent AI, GMB

**Reference**: `routes/webhooks.php`

### 5.4 Cache Configuration: Redis/Valkey (REQUIRED)

Redis (Valkey in development) is **required** for:
- **Session storage** (`SESSION_DRIVER=redis`)
- **Queue backend** (`QUEUE_CONNECTION=redis`)
- **Cache store** (`CACHE_STORE=redis`)
- **Simultaneous ring distributed locking** - Critical for VoIP call answer coordination across devices
- **Laravel Reverb** backend for WebSocket pub/sub

In production, Valkey is provisioned as an AWS ElastiCache-compatible cluster, referenced via `REDIS_URL` from CloudFormation:
```yaml
REDIS_URL:
  from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-valkeyUrl
```

**Reference**: `.env.base:61,78,112`, `copilot/web/manifest.yml:54-57`, `copilot/environments/addons/cache.yml`

### 5.5 WebSocket Server (Laravel Reverb) Deployment

Reverb runs as a **separate ECS service** with its own load balancer path:
- Path: `/reverb*` on `${env}.z360.biz`
- Port: 8080 internally
- Health check: `/reverb/up`

In production, Reverb runs on the same domain but different path (`/reverb`) instead of a different port. This is because the ALB only exposes port 443.

**Reference**: `copilot/reverb/manifest.yml`, `.env.base:88-106`

### 5.6 Database Migrations (VoIP Tables)

VoIP-specific migrations:
1. `2025_09_12_000500_create_user_telnyx_telephony_credentials_table.php` - Per-user Telnyx credentials
2. `2025_09_12_001000_update_user_telnyx_telephony_credentials_table.php` - Credential updates
3. `2025_09_17_000200_add_sip_fields_to_user_telnyx_telephony_credentials_table.php` - SIP username/password
4. `2026_01_05_140119_create_user_device_tokens_table.php` - FCM/APNs device token registration
5. `2026_01_23_053936_add_connection_id_to_user_telnyx_telephony_credentials_table.php` - Connection ID tracking
6. `2026_01_23_170000_add_sip_credentials_to_user_device_tokens_table.php` - Per-device SIP credentials
7. `2026_02_01_000000_add_credential_expires_at_to_user_device_tokens_table.php` - Credential TTL
8. `2026_02_02_102110_create_user_device_tokens_table.php` - Device tokens table (recreated)

Production deployment runs `php artisan migrate --force` as a post-deployment step.

**Reference**: `database/migrations/`, `.github/workflows/deploy-staging.yml:85`

### 5.7 Scheduler/Cron Requirements

The scheduler runs as an AWS Copilot Scheduled Job, executing `php artisan schedule:run` every minute.

VoIP-relevant scheduled tasks (`routes/console.php`):
- `ProcessWakeups` - Runs every minute (likely keeps connections alive)
- `device-tokens:clean-stale` - Weekly cleanup of stale device tokens
- `CheckChannelHealth` - Every 30 minutes, monitors communication channel health

**Reference**: `routes/console.php`, `copilot/scheduler/manifest.yml`

### 5.8 SSL/TLS Requirements

- **Production**: HTTPS enforced via ALB + `FORCE_HTTPS=true`
- **WebSocket**: WSS via ALB on port 443 at path `/reverb`
- **Webhook endpoints**: Must be HTTPS for Telnyx to deliver events
- **Telnyx WebRTC**: Requires HTTPS origin for browser WebRTC APIs
- **Capacitor**: Production uses `https` scheme; development allows cleartext

**Reference**: `copilot/web/manifest.yml:42-43`, `.env.base:10`

### 5.9 Production Nginx Configuration

The production Nginx config (`docker/nginx.conf`):
- Listens on port 80 (behind ALB which terminates TLS)
- Health check at `/api/health` (returns 200 "ok")
- Redirects HTTP to HTTPS when `X-Forwarded-Proto: http` header present
- Routes all requests to Laravel via PHP-FPM socket
- Client max body size: 20MB
- FastCGI buffers: 32k per buffer, 8 buffers

**Reference**: `docker/nginx.conf`

### 5.10 Supervisord (Production)

In production, the web container runs Supervisord managing:
1. `php-fpm8.4 -F` - PHP-FPM (priority 10)
2. `nginx -g "daemon off;"` - Nginx (priority 20)

**Reference**: `docker/supervisord.conf`

---

## 6. ENVIRONMENT DIFFERENCES (Dev vs Production)

### 6.1 APNs Sandbox vs Production

| Setting | Development | Production |
|---------|------------|------------|
| `aps-environment` (iOS entitlement) | `development` | `production` |
| APNs endpoint | `api.sandbox.push.apple.com` | `api.push.apple.com` |
| Provisioning profile | Development | App Store Distribution |

**Reference**: `ios/App/App/App.entitlements`

### 6.2 Telnyx Credentials

| Setting | Development | Production |
|---------|------------|------------|
| `TELNYX_API_KEY` | `.env.base.override` | AWS SSM Parameter Store |
| `TELNYX_CALL_CONTROL_APP_ID` | `.env.base.override` | AWS SSM Parameter Store |
| `TELNYX_CREDENTIAL_CONNECTION_ID` | `.env.base.override` | AWS SSM Parameter Store |
| `TELNYX_NOTIFICATIONS_PROFILE_ID` | `.env.base.override` | AWS SSM Parameter Store |
| Webhook URL | `https://dev.z360.cloud/webhooks/cpaas/telnyx/*` | `https://{env}.z360.biz/webhooks/cpaas/telnyx/*` |

**NEEDS INVESTIGATION**: Whether the same Telnyx account/credentials are used across environments or separate ones.

**Reference**: `.env.base:174-179`, `copilot/web/manifest.yml:93-97`

### 6.3 Firebase Configuration

| Setting | Development | Production |
|---------|------------|------------|
| `FIREBASE_CREDENTIALS` | JSON file path in `storage/` | AWS SSM Parameter Store (JSON string) |
| `google-services.json` (Android) | Local file (gitignored) | Bundled in APK (from CI/CD or manual) |
| `GoogleService-Info.plist` (iOS) | In repo | In repo (same file) |
| FCM project | Same project (z360-c7d9e) | NEEDS INVESTIGATION |

**Reference**: `.env.base.override:87`, `copilot/web/manifest.yml:100`

### 6.4 WebSocket URL Differences

| Setting | Development | Production |
|---------|------------|------------|
| `VITE_REVERB_HOST` | `127.0.0.1` (default) or `ws.dev.z360.cloud` (override) | `{env}.z360.biz` |
| `VITE_REVERB_PORT` | `7361` | `443` |
| `VITE_REVERB_SCHEME` | `http` (default) or `https` (override) | `https` (implicit via port 443) |
| `REVERB_SERVER_PATH` | empty | `/reverb` |
| Internal Reverb host | `reverb:8080` (Docker) | `reverb.{env}.z360.local` (Service Connect) |

**Reference**: `.env.base:83-106`, `.env.base.override:31-33`, `copilot/web/manifest.yml:44,59-66`

### 6.5 Server URL in Capacitor Config

| Setting | Development | Production |
|---------|------------|------------|
| `CAPACITOR_SERVER_URL` | `https://dev.z360.cloud` | Not set (loads from bundled assets) |
| `server.cleartext` | `true` | N/A |
| `androidScheme` | `http` (dev) | `https` |

In development, the Capacitor WebView connects to the remote dev server via tunnel. In production, the WebView loads from the bundled `public/` assets within the app.

**Reference**: `capacitor.config.ts:32-47`, `.env.base:17`

### 6.6 Queue Driver

| Setting | Development | Production |
|---------|------------|------------|
| `QUEUE_CONNECTION` | `redis` | `redis` |
| Queue command | `php artisan queue:listen` (auto-reloads on code change) | `php artisan queue:work` (cached, faster) |

**Reference**: `docker-compose.yml:34`, `copilot/queue/manifest.yml:20-25`

### 6.7 Debug & Logging

| Setting | Development | Production (staging) | Production (beta) |
|---------|------------|---------------------|-------------------|
| `APP_DEBUG` | `true` | `true` | `false` |
| `LOG_STACK` | `single` | `errorlog,nightwatch` / `stderr,nightwatch` | `nightwatch` |
| `LOG_LEVEL` | `debug` | `debug` | `warning` |

**Reference**: `.env.base:5,42-44`, `copilot/web/manifest.yml:106-131`

### 6.8 Storage

| Setting | Development | Production |
|---------|------------|------------|
| Object storage | MinIO (localhost:9000) | AWS S3 |
| `AWS_ENDPOINT` | `http://minio:9000` | empty (uses AWS default) |
| `AWS_USE_PATH_STYLE_ENDPOINT` | `true` | `false` |
| CDN | None | `cdn.{env}.z360.biz` (CloudFront) |

**Reference**: `.env.base:140-147`, `copilot/web/manifest.yml:46-52`

---

## 7. CI/CD PIPELINE

### 7.1 Pipeline Architecture

Z360 uses GitHub Actions with a three-stage pipeline:

```
PR Created  -->  PR Checks (quality-checks.yml)
                    |
Merge to main -->  Main Branch Checks (main-checks.yml)
                    |
                  [All checks pass]
                    |
                  Deploy to Staging (deploy-staging.yml)
                    (10-minute wait, then deploy web + queue + scheduler)
```

**Reference**: `.github/workflows/`

### 7.2 Quality Checks (Reusable Workflow)

Three parallel jobs (`quality-checks.yml`):

**1. Backend Lint** (timeout: 3 min)
- PHP 8.4 setup
- Composer install with cache
- `composer run lint` (Laravel Pint)

**2. Backend Test** (timeout: 35 min)
- PHP 8.4 + Composer install on host
- Node.js 22 + PNPM 9, `pnpm install --frozen-lockfile`
- `pnpm run build` (Vite manifest needed for Inertia tests)
- Docker image build + start services (pgsql, valkey, minio, reverb)
- `php artisan key:generate && migrate --force && db:seed --force`
- `php artisan test`

**3. Frontend Checks** (timeout: 8 min)
- Node.js 22 + PNPM 9
- `pnpm run types` (TypeScript type check)
- `pnpm run format:check` (Prettier)
- `pnpm run lint` (ESLint)

**Reference**: `.github/workflows/quality-checks.yml`

### 7.3 Staging Deployment

Triggered automatically when Main Branch Checks succeed:
1. 10-minute cooldown wait
2. Deploy services via AWS Copilot: `copilot svc deploy -n {service} -e staging`
3. Post-deployment: migrate, config/route/view cache, optimize, queue:restart

**Services deployed**: web, queue, scheduler (note: reverb uses a pre-built ECR image, not deployed in this pipeline)

**Reference**: `.github/workflows/deploy-staging.yml`

### 7.4 Automated Checks Summary

| Check | Tool | Scope |
|-------|------|-------|
| PHP lint | Laravel Pint | Backend code style |
| PHP tests | Pest | Backend unit + feature tests |
| TypeScript | `tsc --noEmit` | Frontend type safety |
| Formatting | Prettier | Frontend code formatting |
| Linting | ESLint | Frontend code quality |

Local equivalent: `make check` (runs lint + types + tests)

**Reference**: `Makefile:340-349`, `package.json:5-14`

### 7.5 What's NOT Automated (NEEDS INVESTIGATION)

- **Android APK/AAB builds** - No CI/CD pipeline for Android releases
- **iOS IPA builds** - No CI/CD pipeline for iOS releases (Xcode Cloud, Fastlane, etc.)
- **Mobile app distribution** - No TestFlight, Firebase App Distribution, or Play Store automation
- **Version bumping** - `versionCode 1` and `versionName "1.0"` in `android/app/build.gradle:27-28` are static
- **Release tagging** - No release workflow or tagging strategy visible
- **Reverb service rebuild** - Uses pre-built ECR image (`108782097218.dkr.ecr.us-east-1.amazonaws.com/z360/web:latest`)
- **Beta/production deployment** - Only staging deployment is automated

### 7.6 Build Artifact Locations

| Artifact | Path | Notes |
|----------|------|-------|
| Debug APK | `android/app/build/outputs/apk/debug/app-debug.apk` | Gitignored |
| Release APK | `android/app/build/outputs/apk/release/app-release.apk` | Gitignored |
| iOS Simulator app | `ios/build/Build/Products/Debug-iphonesimulator/App.app` | Gitignored |
| iOS Device app | `ios/build/Build/Products/Debug-iphoneos/App.app` | Gitignored |
| Web build | `public/build/` | Gitignored, built in Docker |
| Widget build | `public/widget/` | Gitignored, built in Docker |
| Docker image | `z360:dev` (local) / ECR (production) | |

**Reference**: `.gitignore:39-70`

---

## Appendix A: Android Manifest Permissions

Full list of permissions declared in `android/app/src/main/AndroidManifest.xml`:

| Permission | Purpose |
|-----------|---------|
| `INTERNET` | Network access |
| `ACCESS_NETWORK_STATE` | Network status detection |
| `RECORD_AUDIO` | Microphone for VoIP calls |
| `MODIFY_AUDIO_SETTINGS` | Audio routing (speaker, earpiece, Bluetooth) |
| `READ_PHONE_STATE` | Phone state for call management |
| `CALL_PHONE` | Telecom framework integration |
| `POST_NOTIFICATIONS` | Show call notifications (Android 13+) |
| `VIBRATE` | Incoming call vibration |
| `USE_FULL_SCREEN_INTENT` | Full-screen incoming call activity |
| `FOREGROUND_SERVICE` | Keep call alive in background |
| `FOREGROUND_SERVICE_PHONE_CALL` | Phone call foreground service type |
| `FOREGROUND_SERVICE_MICROPHONE` | Microphone foreground service type |
| `WAKE_LOCK` | Prevent sleep during calls |
| `MANAGE_OWN_CALLS` | Android Telecom self-managed calls |
| `BLUETOOTH` (max SDK 30) | Legacy Bluetooth audio |
| `BLUETOOTH_CONNECT` | Bluetooth audio (Android 12+) |

**Reference**: `android/app/src/main/AndroidManifest.xml:5-31`

## Appendix B: Key Makefile Commands Reference

### Docker/App
| Command | Description |
|---------|-------------|
| `make setup` | Complete first-time setup |
| `make up` / `make down` | Start/stop Docker services |
| `make shell` | App container bash |
| `make artisan cmd="..."` | Run artisan command |
| `make check` | Run lint + types + tests |
| `make env` | Regenerate .env file |

### Android
| Command | Description |
|---------|-------------|
| `make android-build` | Full build: sync + gradle + install + launch |
| `make android-restart` | Force stop + relaunch |
| `make android-log-voip` | VoIP-specific logs |
| `make emulator-start` | Start emulator with VoIP settings |

### iOS
| Command | Description |
|---------|-------------|
| `make ios-build` | Full build: sync + xcodebuild + install |
| `make ios-device` | Explicit physical device build |
| `make ios-open` | Open in Xcode |
| `make ios-log-voip` | VoIP-specific logs |

### Tunnel
| Command | Description |
|---------|-------------|
| `make tunnel-bg` | Start Cloudflare tunnel (background) |
| `make tunnel-stop` | Stop tunnel |
| `make tunnel-status` | Check tunnel connectivity |

**Reference**: `Makefile` (full file)
