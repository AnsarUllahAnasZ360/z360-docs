---
title: Telnyx Credentials And Push
---

# Telnyx Credential Model and Push Notification Architecture

## 1. Telnyx Resource Hierarchy

Z360 provisions four infrastructure resources via `telnyx:setup` Artisan command. These are created once per deployment and stored in environment configuration.

```
Telnyx Account
 |
 +-- Outbound Voice Profile (OVP)
 |    - Controls outbound call routing (traffic_type: conversational, service_plan: global)
 |    - Shared by both Credential Connection and Call Control App
 |    - Config key: cpaas.telnyx.ovp_id
 |
 +-- Credential Connection
 |    - Endpoint for WebRTC SIP registrations
 |    - Has its own webhook URLs for call events
 |    - Contains username/password (connection-level, not per-user)
 |    - References the OVP for outbound routing
 |    - Config key: cpaas.telnyx.credential_connection_id
 |    |
 |    +-- Telephony Credentials (many)
 |         - Per-user or per-device SIP credentials
 |         - Each has unique sip_username / sip_password
 |         - All bound to the same Credential Connection
 |
 +-- Call Control Application
 |    - Receives PSTN inbound call webhooks
 |    - Has separate webhook URL from Credential Connection
 |    - References the OVP for outbound routing
 |    - Config key: cpaas.telnyx.call_control_id
 |
 +-- Notification Profile + Channel
      - Receives Telnyx notification events (webhooks)
      - Channel type: webhook, pointed at /webhooks/cpaas/telnyx/notifications
      - Config key: cpaas.telnyx.notifications_profile_id
```

**Source**: `app/Console/Commands/TelnyxSetup.php` (lines 151-416 in skill files.md)

### Credential Connection vs Call Control App

These are **two separate Telnyx resources** that serve different purposes:

| Aspect | Credential Connection | Call Control Application |
|--------|----------------------|------------------------|
| Purpose | WebRTC SIP registrations | PSTN call control |
| Webhook URL | `/webhooks/cpaas/telnyx/credential` | `/webhooks/cpaas/telnyx/inbound` (and `/outbound`) |
| Created via | `POST /credential_connections` (raw HTTP) | Telnyx PHP SDK |
| Hosts | Telephony Credentials (SIP users) | Call legs (PSTN calls) |
| Key feature | `call_parking_enabled: true` | `receive_settings_verification: true` |

**Source**: `app/Console/Commands/TelnyxSetup.php`, `createCredentialConnection()` method (lines 288-330), `createCallControlApplication()` method (lines 333-366)

### How They Work Together

1. **PSTN call arrives** at the Call Control App webhook
2. Z360 looks up which user should receive the call
3. Z360 initiates SIP legs to the user's devices via the **Credential Connection**
4. Each SIP leg targets a specific Telephony Credential's `sip_username`
5. The device's WebRTC client (authenticated via JWT from that credential) receives the incoming SIP INVITE

---

## 2. Credential Types

Z360 uses two tiers of Telnyx Telephony Credentials:

### 2a. Organization-Level Credential

**Purpose**: Legacy/fallback credential for web WebRTC clients. One per user per organization.

**Storage**: `UserTelnyxTelephonyCredential` model

| Field | Description |
|-------|-------------|
| `user_id` | Owning user |
| `organization_id` | Tenant scope |
| `credential_id` | Telnyx credential ID |
| `connection_id` | Credential Connection ID (from config) |
| `sip_username` | Auto-generated by Telnyx |
| `sip_password` | Auto-generated by Telnyx |

**Creation flow** (`CPaaSService::handleCredentials()`):
1. Check if credential exists for `(user_id, organization_id)`
2. If not, call `Telnyx\TelephonyCredential::create()` with `connection_id` and a name like `Org-{orgId}_{random}`
3. Store the returned `sip_username`, `sip_password`, `credential_id`
4. Generate JWT token via `$cred->token()` — 10-hour TTL

**Source**: `app/Services/CPaaSService.php::handleCredentials()` (lines 4316-4362), `app/Models/UserTelnyxTelephonyCredential.php`

### 2b. Per-Device Credential

**Purpose**: Each physical device (phone, tablet, browser tab) gets its own SIP credential. This prevents SIP registration stealing — when a mobile app registers with the same SIP username as the web client, the web client gets deregistered. Per-device credentials solve this.

**Storage**: `UserDeviceToken` model (same row as push token)

| Field | Description |
|-------|-------------|
| `user_id` | Owning user |
| `organization_id` | Tenant scope |
| `device_id` | Client-generated device identifier |
| `fcm_token` | FCM token (Android) or APNs VoIP token (iOS) |
| `platform` | `android`, `ios`, or `web` |
| `device_name` | Human-readable device name |
| `app_version` | Client app version |
| `last_active_at` | Last registration/push activity |
| `telnyx_credential_id` | Per-device Telnyx credential ID |
| `sip_username` | Per-device SIP username |
| `sip_password` | Per-device SIP password |
| `connection_id` | Credential Connection ID |
| `credential_expires_at` | 30 days from creation |

**Creation flow** (`CPaaSService::createDeviceCredential()`):
1. Generate name: `Device-{deviceId}_{random}`
2. Call `Telnyx\TelephonyCredential::create()` with `connection_id`
3. Store `credential_id`, `sip_username`, `sip_password`, `connection_id` on the `UserDeviceToken` row
4. Set `credential_expires_at` to `now()->addDays(30)`

**Source**: `app/Services/CPaaSService.php::createDeviceCredential()` (lines 4368-4390), `app/Models/UserDeviceToken.php`

### JWT Tokens

JWT tokens are short-lived authentication tokens generated from a Telnyx Telephony Credential. They're used by WebRTC clients (both web and mobile) instead of raw SIP passwords.

| Context | JWT Source | TTL |
|---------|-----------|-----|
| Web client (org-level) | `handleCredentials()` → `$cred->token()` | 10 hours |
| Device client (per-device) | `getDeviceJwt()` → `$cred->token()` | 10 hours (Telnyx default) |

The JWT is returned to the client at device registration time (via `DeviceTokenController::store()` response) and via `VoipCredentialController::show()` for on-demand refresh.

**Source**: `app/Services/CPaaSService.php::getDeviceJwt()` (lines 4410-4418)

### Credential Type Comparison

```
                     Org-Level Credential              Per-Device Credential
                     =====================              =====================
Stored in:           UserTelnyxTelephonyCredential      UserDeviceToken
Scope:               1 per (user, organization)         1 per (user, organization, device)
Naming:              Org-{orgId}_{random}               Device-{deviceId}_{random}
Expiry:              No explicit expiry                  30 days (credential_expires_at)
JWT TTL:             10 hours                            10 hours
Used by:             Web fallback                        All platforms (web, android, ios)
Created when:        handleCredentials() called          DeviceTokenController::store() called
Enables sim-ring:    No (single SIP user)               Yes (each device has own SIP leg)
```

---

## 3. Push Notification Architecture

### Key Architectural Decision: Server-Mediated Push

**Z360 does NOT use Telnyx's native push credential binding.** Instead, Z360 implements a server-mediated push model:

```
  PSTN Caller
      |
      v
  Telnyx Call Control App
      | (webhook: call.initiated)
      v
  Z360 Backend (TelnyxInboundWebhookController)
      |
      +-- Looks up receiving user from channel config
      |
      +-- Sends push notifications DIRECTLY to devices:
      |     +-- FCM (Android) via Google FCM HTTP v1 API
      |     +-- APNs VoIP Push (iOS) via ApnsVoipService
      |
      +-- Broadcasts to web sessions via Laravel Reverb (WebSocket)
      |
      +-- Initiates SIP legs to per-device credentials
           (simultaneous ring to all active devices)
```

### Why Server-Mediated Push?

Telnyx's native push model would require:
- Registering FCM/APNs tokens with Telnyx per credential
- Telnyx sending push notifications when a SIP INVITE targets a credential

Z360 instead handles push itself because:
1. **Multi-org routing**: The push payload includes `organization_id`, `organization_name`, `organization_slug` for client-side org context
2. **Rich data**: Push includes `caller_name`, `caller_avatar`, `channel_number` resolved from Z360's contact database
3. **Unified control**: Same codebase manages push, WebSocket broadcasts, and SIP leg creation in a coordinated sequence
4. **Call correlation**: Push includes `call_session_id` and `call_control_id` for end-to-end correlation

### Push Notification Flow (Inbound Call)

```
1. PSTN call arrives at Call Control App
   |
2. TelnyxInboundWebhookController::handleCallInitiated()
   |
3. Determine receiving user from channel's receiving_user_id
   |
4. Collect all devices for user:
   |  - FCM tokens: UserDeviceToken::getFcmTokensForUserInOrganization()
   |  - APNs tokens: UserDeviceToken::getApnsVoipTokensForUserInOrganization()
   |
5. Send push notifications (PushNotificationService::sendIncomingCallPush):
   |  - FCM: POST to fcm.googleapis.com/v1/projects/{id}/messages:send
   |    - Priority: HIGH, TTL: 60s
   |    - Data-only message (no notification key)
   |  - APNs: VoIP push via ApnsVoipService::sendVoipPush()
   |    - content-available: 1
   |
6. Broadcast to web sessions via Reverb (IncomingCallNotification event)
   |
7. Initiate SIP legs for simultaneous ring:
   |  For each device with sip_username:
   |    Telnyx\Call::create() with SIP URI targeting device's sip_username
   |    at the Credential Connection
   |
8. First device to answer → bridge with parent PSTN call
   Other legs → hang up
   All devices → PushNotificationService::sendCallEndedPush()
```

**Source**: `app/Http/Controllers/Telnyx/TelnyxInboundWebhookController.php` (lines 1780-1973)

### Push Payload Structure

**Incoming Call (FCM)**:
```json
{
  "type": "incoming_call",
  "call_session_id": "...",
  "call_control_id": "...",
  "caller_number": "+15551234567",
  "caller_name": "John Doe",
  "channel_number": "+15559876543",
  "timestamp": "1717000000",
  "caller_avatar": "https://...",
  "call_id": "...",
  "organization_id": "42",
  "organization_name": "Acme Corp",
  "organization_slug": "acme-corp"
}
```

**Call Ended (FCM)**:
```json
{
  "type": "call_ended",
  "call_session_id": "..."
}
```

**Source**: `app/Services/PushNotificationService.php` (lines 20-157, 162-228)

### Push Token Management

**Registration** (`POST /api/device-tokens`):
- Client sends: `fcm_token`, `platform`, `device_id`, `device_name`, `app_version`
- Server upserts `UserDeviceToken` keyed by `(user_id, organization_id, device_id)`
- Server creates per-device SIP credential if none exists
- Returns SIP credentials + JWT in response

**Removal** (`DELETE /api/device-tokens/{deviceId}`):
- Deletes Telnyx credential first (`CPaaSService::deleteTelnyxCredential()`)
- Then deletes the `UserDeviceToken` row

**Auto-cleanup on push failure**:
- FCM `UNREGISTERED` or `INVALID_ARGUMENT` errors → `UserDeviceToken::removeToken()`
- FcmChannel `NotFound` or `InvalidMessage` exceptions → device record deleted

**Source**: `app/Http/Controllers/Api/DeviceTokenController.php` (lines 42-177, 183-213), `app/Services/PushNotificationService.php` (lines 109-112)

---

## 4. Credential Lifecycle

### Creation Triggers

| Trigger | Credential Type | Method |
|---------|----------------|--------|
| Device registers (`POST /api/device-tokens`) | Per-device | `DeviceTokenController::store()` → `CPaaSService::createDeviceCredential()` |
| Web app loads VoIP (`GET /api/voip/credentials`) | Org-level | `VoipCredentialController::show()` → `CPaaSService::handleCredentials()` |
| Org switch (`POST /api/voip/switch-org`) | Org-level | `VoipCredentialController::switchOrg()` → `CPaaSService::handleCredentials()` |
| Device registration also triggers org-level | Org-level | `DeviceTokenController::store()` → `CPaaSService::handleCredentials()` |

### Expiry and Refresh

| Credential | Expiry | Refresh Mechanism |
|------------|--------|------------------|
| Org-level SIP credential | No explicit expiry set | Persists indefinitely |
| Per-device SIP credential | 30 days (`credential_expires_at`) | New credential created on next device registration |
| JWT token (org-level) | 10 hours (Telnyx default) | Re-requested on each `handleCredentials()` call |
| JWT token (per-device) | 10 hours (Telnyx default) | Re-requested on each `getDeviceJwt()` call |

**Note**: The 30-day expiry on per-device credentials is tracked in Z360's database (`credential_expires_at`), but Z360 does not currently have a scheduled job to rotate expired credentials. Expiry cleanup depends on devices re-registering or being cleaned up as stale.

### Cleanup Mechanisms

#### 1. Stale Device Cleanup (during registration)

When a device registers, Z360 removes same-platform devices for the same user+org that haven't been active in 7+ days:

```
Trigger: DeviceTokenController::store()
Scope:   Same user, same org, same platform, different device_id
Filter:  last_active_at < now() - 7 days
Action:  Delete Telnyx credential → Delete UserDeviceToken row
```

**Source**: `app/Http/Controllers/Api/DeviceTokenController.php` (lines 132-159)

#### 2. Web Device Dedup (during registration)

When a web device registers, Z360 enforces max 1 web device per user+org:

```
Trigger: DeviceTokenController::store() when platform === 'web'
Scope:   Same user, same org, platform 'web', different device_id
Action:  Delete Telnyx credential → Delete UserDeviceToken row
```

**Source**: `app/Http/Controllers/Api/DeviceTokenController.php` (lines 57-81)

#### 3. Old Credential Cleanup (during re-registration)

When a device re-registers and its existing row has no `sip_username`, the old Telnyx credential (if any) is deleted before creating a new one:

```
Trigger: DeviceTokenController::store() when existing device has old credential
Action:  CPaaSService::deleteTelnyxCredential(oldCredentialId) → createDeviceCredential()
```

**Source**: `app/Http/Controllers/Api/DeviceTokenController.php` (lines 108-115)

#### 4. Invalid Token Cleanup (during push send)

```
Trigger: PushNotificationService::sendIncomingCallPush() or FcmChannel::send()
Errors:  FCM UNREGISTERED, INVALID_ARGUMENT, NotFound, InvalidMessage
Action:  UserDeviceToken::removeToken(fcmToken)
```

**Source**: `app/Services/PushNotificationService.php` (lines 109-112), `app/Channels/FcmChannel.php`

#### 5. Manual Device Removal

```
Trigger: DELETE /api/device-tokens/{deviceId}
Action:  Delete Telnyx credential FIRST → Delete UserDeviceToken row
```

**Source**: `app/Http/Controllers/Api/DeviceTokenController.php` (lines 183-213)

### Credential Lifecycle Diagram

```
                    CREATION
                       |
  +--------------------+--------------------+
  |                                         |
  v                                         v
  Org-Level                             Per-Device
  (handleCredentials)                   (createDeviceCredential)
  |                                         |
  | No expiry set                           | 30-day expiry
  | Persists until user                     | Persists until:
  | leaves org or                           |   - Device re-registers (7d stale)
  | credential manually                    |   - Web dedup (max 1)
  | deleted                                 |   - Manual removal (DELETE)
  |                                         |   - Push failure (UNREGISTERED)
  v                                         v
  JWT (10h TTL)                         JWT (10h TTL)
  Re-fetched on each                    Re-fetched on each
  show()/switchOrg()                    DeviceTokenController::store()
```

---

## 5. Multi-Organization Credential Architecture

### Shared Infrastructure, Per-Org Data

Z360 uses a **single Credential Connection** shared across all organizations. This is a platform-level config, not per-tenant:

```
Config: cpaas.telnyx.credential_connection_id  (single value, all orgs)
Config: cpaas.telnyx.call_control_id           (single value, all orgs)
Config: cpaas.telnyx.ovp_id                    (single value, all orgs)
```

But credentials and device tokens are **per-organization**:

```
UserTelnyxTelephonyCredential:  scoped by (user_id, organization_id)
UserDeviceToken:                scoped by (user_id, organization_id, device_id)
```

This means:
- A user in 3 organizations has **3 separate org-level credentials** (one per org)
- A user with 2 devices in 3 organizations has up to **6 device credentials**
- All credentials point to the **same Credential Connection**
- Inbound calls route to the correct org because the call arrives at a specific phone number → channel → organization

### Organization Switching

When a user switches organizations (e.g., answering a call from a different org on Android):

1. Client calls `POST /api/voip/switch-org` with `target_organization_id`
2. Server verifies user belongs to the target org
3. Server calls `$organization->switchTo()` (sets current tenant)
4. Server retrieves/creates credentials for the new org
5. Returns new `sip_username`, `sip_password`, `jwt_token`, `organization_id`

The push notification payload includes `organization_id` so the mobile client knows which org context to use when displaying the incoming call UI.

**Source**: `app/Http/Controllers/Api/VoipCredentialController.php::switchOrg()` (lines 109-218)

### Cross-Org Call Routing

```
PSTN Call → Phone Number → Channel (org-scoped) → receiving_user_id
                                                        |
                                                        v
                                                 Look up devices for user
                                                 IN THIS ORGANIZATION
                                                        |
                                                        v
                                                 Send push with org context
                                                 Initiate SIP legs to
                                                 org-scoped device credentials
```

Push tokens are retrieved with org-scoping when org context is available:
- `UserDeviceToken::getFcmTokensForUserInOrganization(userId, orgId)`
- `UserDeviceToken::getApnsVoipTokensForUserInOrganization(userId, orgId)`

**Source**: `app/Services/PushNotificationService.php` (lines 33-40)

---

## 6. Z360 Approach vs SDK Expectations

### What the Telnyx SDKs Expect

The Telnyx WebRTC SDKs (Android, iOS, Web) expect:
1. Client receives a **JWT token** (or SIP username/password) to authenticate with Telnyx
2. Client connects to Telnyx WebRTC gateway and **registers** with the SIP credential
3. **Telnyx sends SIP INVITEs** directly to the registered client when someone calls the associated number
4. For mobile apps, Telnyx can send **push notifications** via its native push credential system to wake sleeping apps

### What Z360 Does Differently

| Aspect | SDK Default | Z360 Implementation |
|--------|-------------|---------------------|
| **Push delivery** | Telnyx sends push to device via registered push credentials | Z360 backend sends FCM/APNs directly |
| **Call routing** | Telnyx routes to registered SIP client | Z360 initiates SIP legs explicitly via `Call::create()` |
| **Credential scope** | One credential per client | Per-device credentials for simultaneous ring |
| **Org context** | Not applicable | Push includes org metadata for multi-tenant routing |
| **Call control** | Client-side call control | Server-side orchestration (park, bridge, transfer) |

### Implications

1. **Simultaneous ring**: Z360's per-device credential model enables ringing all devices simultaneously, which is harder with Telnyx's default "last registered wins" model
2. **Server-side control**: Z360 maintains full control over call routing decisions (voicemail, sim-ring timeout, answered-elsewhere hangup) because it orchestrates call legs from the backend
3. **Dual connection model**: The Credential Connection receives WebRTC registrations; the Call Control App receives PSTN call events. Z360 bridges between them programmatically
4. **No Telnyx push dependency**: Z360's push infrastructure (FCM/APNs) is completely independent of Telnyx, giving full control over push payload content and delivery timing

---

## 7. Telnyx PHP SDK Credential API Reference

From the Telnyx PHP SDK (`telnyx-php-sdk.xml` pack):

### TelephonyCredential Resource

**File**: `src/TelephonyCredentials/TelephonyCredential.php`

Properties:
- `id` — Unique credential identifier
- `sipUsername` — Auto-generated SIP username
- `sipPassword` — Auto-generated SIP password
- `connectionID` — The Credential Connection this credential belongs to
- `resourceID` — Linked resource identifier
- `name` — Human-assigned name
- `tag` — Grouping tag (max 1000 credentials per tag)
- `expiresAt` — Optional ISO-8601 expiration
- `expired` — Boolean expiration flag
- `createdAt` / `updatedAt` — Timestamps
- `recordType` — Resource type identifier

### API Operations

| Operation | Method | Notes |
|-----------|--------|-------|
| Create | `TelephonyCredential::create(['connection_id' => ..., 'name' => ...])` | `connectionID` required |
| Retrieve | `TelephonyCredential::retrieve($id)` | Returns full credential |
| Update | `$cred->save()` | Can update `connectionID`, `name`, `expiresAt`, `tag` |
| Delete | via raw HTTP `DELETE /telephony_credentials/{id}` | Z360 uses `CPaaSService::telnyxRequest()` |
| List | `TelephonyCredential::all(['filter' => ...])` | Filter by name, sipUsername, status, tag, resourceID |
| Token | `$cred->token()` | Returns JWT for WebRTC auth |

### Create Parameters

**File**: `src/TelephonyCredentials/TelephonyCredentialCreateParams.php`

| Parameter | Required | Description |
|-----------|----------|-------------|
| `connectionID` | Yes | Credential Connection ID |
| `name` | No | Human-readable name |
| `expiresAt` | No | ISO-8601 expiration date |
| `tag` | No | Grouping tag |

### Filter Parameters

**File**: `src/TelephonyCredentials/TelephonyCredentialListParams/Filter.php`

| Filter | Description |
|--------|-------------|
| `name` | Filter by credential name |
| `sipUsername` | Filter by SIP username |
| `status` | Filter by credential status |
| `tag` | Filter by tag |
| `resourceID` | Filter by resource ID |

---

## File Reference Index

All claims in this document are backed by the following source files:

| File | Key Content |
|------|-------------|
| `app/Console/Commands/TelnyxSetup.php` | Infrastructure provisioning: OVP, Credential Connection, Call Control App, Notification Profile |
| `app/Services/CPaaSService.php` | `handleCredentials()`, `createDeviceCredential()`, `deleteTelnyxCredential()`, `getDeviceJwt()`, `telnyxRequest()` |
| `app/Models/UserTelnyxTelephonyCredential.php` | Org-level credential Eloquent model |
| `app/Models/UserDeviceToken.php` | Per-device credential + push token model, static token retrieval methods |
| `app/Http/Controllers/Api/DeviceTokenController.php` | Device registration, stale cleanup, web dedup, credential creation |
| `app/Http/Controllers/Api/VoipCredentialController.php` | `show()` for web credentials, `switchOrg()` for multi-org |
| `app/Http/Controllers/Telnyx/TelnyxInboundWebhookController.php` | Inbound call routing, sim-ring orchestration, push triggers |
| `app/Services/PushNotificationService.php` | FCM/APNs push delivery, invalid token cleanup |
| `app/Channels/FcmChannel.php` | Laravel notification channel for FCM |
| `app/Services/Telnyx/NotificationProfile.php` | Telnyx Notification Profile API wrapper |
| `app/Services/Telnyx/NotificationChannel.php` | Telnyx Notification Channel API wrapper |
| `app/Services/ApnsVoipService.php` | APNs VoIP push delivery |
| `.scratchpad/packs/telnyx-php-sdk.xml` | Telnyx PHP SDK: TelephonyCredential, CallControl, credential operations |
